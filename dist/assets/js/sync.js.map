{"version":3,"file":"sync.js","sources":["../../../src/util/event.ts","../../../src/helper/sync.ts"],"sourcesContent":["export class SimpleEvent<T extends string> {\n  callbacks: {\n    [propName: string]: any;\n  } = {};\n\n  constructor() {}\n\n  on(name: T, fn: Function) {\n    if (this.callbacks[name]) {\n      this.callbacks[name].push(fn);\n    } else {\n      this.callbacks[name] = [fn];\n    }\n  }\n\n  emit(name: T, ...args) {\n    const fns = this.callbacks[name];\n\n    if (fns && fns.length) {\n      fns.forEach((fn) => fn.apply(this, args));\n    }\n  }\n\n  off(name: T, fn: Function) {\n    const fns = this.callbacks[name];\n\n    if (fns && fns.length) {\n      if (fn) {\n        const newFns = fns.filter((item) => item !== fn);\n\n        if (newFns.length) {\n          this.callbacks[name] = newFns;\n        } else {\n          delete this.callbacks[name];\n        }\n      } else {\n        delete this.callbacks[name];\n      }\n    }\n  }\n}\n","import { throttle } from \"lodash\";\nimport {\n  STORAGE_KEYS,\n  SYNC_STATUS,\n  WEBDAV_MAX_SYNC_INTERVAL,\n  WEBDAV_MIN_SYNC_INTERVAL,\n} from \"../common/constant\";\nimport { SimpleEvent } from \"../util/event\";\nimport { tuple } from \"../util/types\";\nimport { onDbUpdate } from \"./db.helper\";\nimport { createDataSyncTick, isWebDavConfiged } from \"./webdav\";\n\nconst EventTypes = tuple(\"received\", \"uploaded\");\n\nexport type EventType = typeof EventTypes[number];\n\nexport function isAutoSync() {\n  return chrome.storage.local.get(STORAGE_KEYS.AUTO_SYNC).then((res) => {\n    return res[STORAGE_KEYS.AUTO_SYNC] === 1;\n  });\n}\n\nexport default class Sync extends SimpleEvent<EventType> {\n  syncStatus;\n  syncTimer = 0;\n  syncInterval = WEBDAV_MAX_SYNC_INTERVAL;\n\n  constructor(options?: { syncInterval?: number }) {\n    super();\n    this.syncInterval = options?.syncInterval ?? WEBDAV_MAX_SYNC_INTERVAL;\n    this.tryStartSync();\n    this.setupAutoSync();\n  }\n\n  setupAutoSync() {\n    onDbUpdate(() => {\n      isAutoSync().then((bool) => {\n        if (bool) {\n          this.tryStartSync();\n        }\n      });\n    });\n  }\n\n  stopSync() {\n    clearInterval(this.syncTimer);\n    this.syncStatus = SYNC_STATUS.WAIT;\n  }\n\n  async runDataSyncTick() {\n    try {\n      const newReceived = await createDataSyncTick();\n\n      if (newReceived) {\n        this.emit(\"received\");\n      }\n      this.syncStatus = SYNC_STATUS.SUCCESS;\n    } catch (error) {\n      console.log(error);\n      this.syncStatus = SYNC_STATUS.FAIL;\n    }\n  }\n\n  private getSyncInterval() {\n    const interval = this.syncInterval || WEBDAV_MAX_SYNC_INTERVAL;\n\n    return interval;\n  }\n\n  startSync = throttle(async function (this: Sync) {\n    this.stopSync();\n    this.syncStatus = SYNC_STATUS.BEGIN;\n    await this.runDataSyncTick();\n\n    const inerval = this.getSyncInterval();\n\n    this.syncTimer = setInterval(async () => {\n      await this.runDataSyncTick();\n    }, inerval) as any;\n  }, WEBDAV_MIN_SYNC_INTERVAL);\n\n  tryStartSync() {\n    if (isWebDavConfiged()) {\n      this.startSync();\n    }\n  }\n}\n"],"names":["SimpleEvent","__publicField","name","fn","args","fns","newFns","item","isAutoSync","STORAGE_KEYS","res","Sync","options","WEBDAV_MAX_SYNC_INTERVAL","throttle","SYNC_STATUS","inerval","WEBDAV_MIN_SYNC_INTERVAL","_a","onDbUpdate","bool","createDataSyncTick","error","isWebDavConfiged"],"mappings":"oPAAO,MAAMA,CAA8B,CAKzC,aAAc,CAJdC,EAAA,iBAEI,CAAA,EAEW,CAEf,GAAGC,EAASC,EAAc,CACpB,KAAK,UAAUD,GACZ,KAAA,UAAUA,GAAM,KAAKC,CAAE,EAEvB,KAAA,UAAUD,GAAQ,CAACC,CAAE,CAE9B,CAEA,KAAKD,KAAYE,EAAM,CACf,MAAAC,EAAM,KAAK,UAAUH,GAEvBG,GAAOA,EAAI,QACbA,EAAI,QAASF,GAAOA,EAAG,MAAM,KAAMC,CAAI,CAAC,CAE5C,CAEA,IAAIF,EAASC,EAAc,CACnB,MAAAE,EAAM,KAAK,UAAUH,GAEvB,GAAAG,GAAOA,EAAI,OACb,GAAIF,EAAI,CACN,MAAMG,EAASD,EAAI,OAAQE,GAASA,IAASJ,CAAE,EAE3CG,EAAO,OACT,KAAK,UAAUJ,GAAQI,EAEvB,OAAO,KAAK,UAAUJ,EACxB,MAEA,OAAO,KAAK,UAAUA,EAG5B,CACF,CCxBO,SAASM,GAAa,CACpB,OAAA,OAAO,QAAQ,MAAM,IAAIC,EAAa,SAAS,EAAE,KAAMC,GACrDA,EAAID,EAAa,aAAe,CACxC,CACH,CAEA,MAAqBE,UAAaX,CAAuB,CAKvD,YAAYY,EAAqC,OACzC,QALRX,EAAA,mBACAA,EAAA,iBAAY,GACZA,EAAA,oBAAeY,GA4CfZ,EAAA,iBAAYa,mBAAS,gBAA4B,CAC/C,KAAK,SAAS,EACd,KAAK,WAAaC,EAAY,MAC9B,MAAM,KAAK,kBAEL,MAAAC,EAAU,KAAK,kBAEhB,KAAA,UAAY,YAAY,SAAY,CACvC,MAAM,KAAK,mBACVA,CAAO,GACTC,CAAwB,GAlDpB,KAAA,cAAeC,EAAAN,GAAA,YAAAA,EAAS,eAAT,KAAAM,EAAyBL,EAC7C,KAAK,aAAa,EAClB,KAAK,cAAc,CACrB,CAEA,eAAgB,CACdM,EAAW,IAAM,CACJX,EAAA,EAAE,KAAMY,GAAS,CACtBA,GACF,KAAK,aAAa,CACpB,CACD,CAAA,CACF,CACH,CAEA,UAAW,CACT,cAAc,KAAK,SAAS,EAC5B,KAAK,WAAaL,EAAY,IAChC,CAEA,MAAM,iBAAkB,CAClB,GAAA,CACkB,MAAMM,KAGxB,KAAK,KAAK,UAAU,EAEtB,KAAK,WAAaN,EAAY,cACvBO,GACP,QAAQ,IAAIA,CAAK,EACjB,KAAK,WAAaP,EAAY,IAChC,CACF,CAEQ,iBAAkB,CAGjB,OAFU,KAAK,cAAgBF,CAGxC,CAcA,cAAe,CACTU,KACF,KAAK,UAAU,CAEnB,CACF"}